---
import BaseLayout from "../../../layouts/BaseLayout.astro";
import { formatExample, getAllCheatsheets, loadCheatsheet } from "../../../lib/cheatsheets";

export async function getStaticPaths() {
  return getAllCheatsheets().map((ref) => ({
    params: { product: ref.product, name: ref.name },
    props: { filePath: ref.filePath },
  }));
}

type Props = {
  filePath: string;
};

const { filePath } = Astro.props;
const data = loadCheatsheet(filePath);
const all = getAllCheatsheets();
const ref = all.find((r) => r.filePath === filePath);

const title = data.title || "Cheatsheet";
---

<BaseLayout title={`${title} | ChSON`} description={data.description}>
  <div class="top">
    <div>
      <h1 class="h">{title}</h1>
      <div class="meta">
        {data.version ? <span>Version: <strong>{data.version}</strong></span> : null}
        {data.publicationDate ? <span>Published: <strong>{data.publicationDate}</strong></span> : null}
        {ref ? <span class="path">{ref.product}/{ref.name}</span> : null}
      </div>
      <p class="desc">{data.description}</p>
    </div>
    <div class="actions">
      <a class="btn" href={`${import.meta.env.BASE_URL}cheatsheets/`}>All cheatsheets</a>
      {ref ? (
        <a
          class="btn ghost"
          href={`https://github.com/carlesandres/csif.sh/blob/main/cheatsheets/${ref.product}/${ref.name}.chson.json`}
        >
          View source
        </a>
      ) : null}
    </div>
  </div>

  {Array.isArray(data.sections) && data.sections.length ? (
    <div class="sections">
      {data.sections.map((section) => (
        <section class="section">
          <h2 class="sh">{section.title}</h2>
          {section.description ? <p class="sd">{section.description}</p> : null}
          <div class="tableWrap">
            <table class="table">
              <thead>
                <tr>
                  <th>Example</th>
                  <th>Description</th>
                </tr>
              </thead>
              <tbody>
                {Array.isArray(section.items)
                  ? section.items.map((item) => (
                      <tr>
                        <td class="ex">
                          {formatExample(item.example ?? item.title) ? (
                            <pre><code>{formatExample(item.example ?? item.title)}</code></pre>
                          ) : null}
                        </td>
                        <td class="tx">
                          <div class="it">{item.title}</div>
                          <div class="id">{item.description}</div>
                        </td>
                      </tr>
                    ))
                  : null}
              </tbody>
            </table>
          </div>
        </section>
      ))}
    </div>
  ) : (
    <p>No sections found.</p>
  )}
</BaseLayout>

<style>
  .top {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    gap: 16px;
    flex-wrap: wrap;
  }

  .h {
    font-family: "Space Grotesk", ui-sans-serif, system-ui, -apple-system, "Segoe UI", sans-serif;
    letter-spacing: -0.03em;
    margin: 0 0 10px;
    font-size: clamp(28px, 4.2vw, 44px);
    line-height: 1.08;
  }

  .meta {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    color: var(--muted);
    font-size: 13px;
    margin-bottom: 12px;
  }

  .path {
    padding: 2px 8px;
    border: 1px solid rgba(0, 0, 0, 0.10);
    border-radius: 999px;
    background: rgba(0, 0, 0, 0.03);
  }

  .desc { margin: 0 0 18px; max-width: 80ch; color: var(--muted); }

  .actions { display: flex; gap: 10px; }
  .btn {
    display: inline-block;
    padding: 10px 12px;
    border-radius: 14px;
    border: 1px solid rgba(0, 0, 0, 0.12);
    background: rgba(255, 255, 255, 0.65);
  }
  .btn:hover { text-decoration: none; border-color: rgba(0, 0, 0, 0.18); }
  .btn.ghost { background: rgba(11, 91, 211, 0.10); }

  .sections { display: grid; gap: 22px; }
  .section {
    border: 1px solid var(--stroke);
    border-radius: var(--radius);
    background: rgba(255, 255, 255, 0.70);
    box-shadow: var(--shadow);
    padding: 16px;
  }

  .sh { margin: 0 0 6px; font-size: 18px; }
  .sd { margin: 0 0 12px; color: var(--muted); }

  .tableWrap { overflow: auto; border-radius: 14px; border: 1px solid rgba(0, 0, 0, 0.10); }
  .table { width: 100%; border-collapse: collapse; min-width: 640px; }
  .table th {
    text-align: left;
    font-size: 13px;
    color: var(--muted);
    background: rgba(0, 0, 0, 0.03);
    padding: 10px;
    border-bottom: 1px solid rgba(0, 0, 0, 0.10);
  }
  .table td {
    padding: 10px;
    vertical-align: top;
    border-bottom: 1px solid rgba(0, 0, 0, 0.06);
  }
  .table tr:last-child td { border-bottom: none; }

  pre {
    margin: 0;
    padding: 10px;
    border-radius: 12px;
    background: rgba(10, 10, 10, 0.04);
    border: 1px solid rgba(0, 0, 0, 0.08);
    overflow: auto;
  }
  code { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }

  .it { font-weight: 700; margin-bottom: 4px; }
  .id { color: var(--muted); }

  @media (max-width: 640px) {
    .actions { width: 100%; }
  }
</style>
